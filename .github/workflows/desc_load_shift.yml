name: Process DESC Users in Parallel

on:
  workflow_dispatch:
    inputs:
      s3_path:
        description: "S3 location to upload merged output file"
        required: true
        default: "s3://bidgely-adhoc-productqa/ReCreatingProdData/BalaKrishna/output.xlsx"

jobs:
  process-users:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start Timer
        id: timer_start
        run: echo "start_time=$(date +%s)" >> $GITHUB_ENV

      - name: Calculate Batch Range
        id: calc
        run: |
          TOTAL=$(wc -l < users.csv)   # total lines in file
          JOBS=20
          SIZE=$(( (TOTAL + JOBS - 1) / JOBS ))+1   # ceil division

          INDEX=${{ matrix.batch }}
          START=$(( INDEX * SIZE + 1 ))
          END=$(( (INDEX + 1) * SIZE ))
          if [ $END -gt $TOTAL ]; then END=$TOTAL; fi

          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END" >> $GITHUB_OUTPUT

      - name: Run batch
        run: |
          echo "Processing lines ${{ steps.calc.outputs.start }} to ${{ steps.calc.outputs.end }}..."
          python desc_email.py \
            --input users.csv \
            --start ${{ steps.calc.outputs.start }} \
            --end ${{ steps.calc.outputs.end }} \
            --output output_${{ matrix.batch }}.csv

      - name: End Timer and Log Duration
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - $start_time))
          echo "â±ï¸ Job ${{ matrix.batch }} finished in $DURATION seconds"

      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.batch }}
          path: output_${{ matrix.batch }}.csv

  merge-results:
    runs-on: ubuntu-latest
    needs: process-users
    steps:
      - name: Start Workflow Timer
        id: wf_start
        run: echo "wf_start_time=$(date +%s)" >> $GITHUB_ENV

      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download all batch artifacts
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Merge all CSV files
        run: |
          mkdir merged
          HEADER_WRITTEN=false
          OUTFILE=merged/output.csv

          for file in results/**/output_*.csv; do
            echo "Merging $file"
            if [ "$HEADER_WRITTEN" = false ]; then
              cat "$file" > "$OUTFILE"
              HEADER_WRITTEN=true
            else
              tail -n +2 "$file" >> "$OUTFILE"
            fi
          done

          echo "âœ… Merged CSV written to $OUTFILE"

      - name: Convert CSV to Excel
        run: |
          echo "ðŸ“Š Converting CSV to Excel..."
          pip install pandas openpyxl
          python - <<EOF
          import pandas as pd
          df = pd.read_csv("merged/output.csv")
          df.to_excel("merged/output.xlsx", index=False)
          print("âœ… Conversion complete: merged/output.xlsx")
          EOF

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-west-2

      - name: Upload results to S3
        run: |
          echo "Uploading to ${{ github.event.inputs.s3_path }}"
          aws s3 cp merged/output.xlsx ${{ github.event.inputs.s3_path }}

      - name: End Workflow Timer and Log Duration
        run: |
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - $wf_start_time))
          echo "â±ï¸ Total workflow (merge + upload) finished in $DURATION seconds"

      - name: Send email with S3 link
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: 'User Processing Report - ${{ github.run_number }}'
          html_body: |
            <h4>The user processing script has completed âœ…</h4> 
            <p>The result file is uploaded to S3:</p>
            <p><code>${{ github.event.inputs.s3_path }}</code></p>
            <br>
            Run Number: ${{ github.run_number }}<br>
            Repository: ${{ github.repository }}
          to: balakrishnam@bidgely.com
          from: GitHub Actions <actions@github.com>

      - name: Delete all intermediate artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: |
            results-batch-*