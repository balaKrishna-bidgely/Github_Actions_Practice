name: Process Users in Parallel

on:
  workflow_dispatch:

jobs:
  process-users:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        batch: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Calculate Batch Range
        id: calc
        run: |
          TOTAL=$(wc -l < users.csv)   # total lines in file
          JOBS=20
          SIZE=$(( (TOTAL + JOBS - 1) / JOBS ))   # ceil division

          INDEX=${{ matrix.batch }}
          START=$(( INDEX * SIZE + 1 ))
          END=$(( (INDEX + 1) * SIZE ))
          if [ $END -gt $TOTAL ]; then END=$TOTAL; fi

          echo "start=$START" >> $GITHUB_OUTPUT
          echo "end=$END" >> $GITHUB_OUTPUT

      - name: Run batch
        run: |
          echo "Processing lines ${{ steps.calc.outputs.start }} to ${{ steps.calc.outputs.end }}..."
          python desc_email.py \
            --input users.csv \
            --start ${{ steps.calc.outputs.start }} \
            --end ${{ steps.calc.outputs.end }} \
            --output output_${{ matrix.batch }}.csv

      - name: Upload CSV artifacts
        uses: actions/upload-artifact@v4
        with:
          name: results-batch-${{ matrix.batch }}
          path: output_${{ matrix.batch }}.csv

  merge-results:
    runs-on: ubuntu-latest
    needs: process-users
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Download all batch artifacts
        uses: actions/download-artifact@v4
        with:
          path: results

      - name: Merge all CSV files
        run: |
          mkdir merged
          HEADER_WRITTEN=false
          OUTFILE=merged/output.csv

          for file in results/**/output_*.csv; do
            echo "Merging $file"
            if [ "$HEADER_WRITTEN" = false ]; then
              cat "$file" > "$OUTFILE"
              HEADER_WRITTEN=true
            else
              tail -n +2 "$file" >> "$OUTFILE"
            fi
          done

          echo "✅ Merged CSV written to $OUTFILE"

      - name: Compress final output
        run: |
          gzip -c merged/output.csv > merged/output.csv.gz
          echo "✅ Compressed file: merged/output.csv.gz"

      - name: Commit merged file
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          cp merged/output.csv.gz ./output.csv.gz
          git add output.csv.gz
          git commit -m "Add/update final merged compressed output.csv.gz" || echo "No changes to commit"
          git push

      - name: Send email with compressed file
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.GMAIL_USERNAME }}
          password: ${{ secrets.GMAIL_APP_PASSWORD }}
          subject: 'User Processing Report - ${{ github.run_number }}'
          html_body: |
            <h4>The user processing script has completed.</h4> 
            <p>Please find the compressed <code>output.csv.gz</code> attached.</p>
            
            Run Number: ${{ github.run_number }}<br>
            Repository: ${{ github.repository }}
          to: balakrishnam@bidgely.com
          from: GitHub Actions <actions@github.com>
          attachments: output.csv.gz
